cat > /workspace/gerar_graficos.py << 'SCRIPT_EOF'
#!/usr/bin/env python3
"""Script para Gerar GrÃ¡ficos Comparativos - Tema B (VersÃ£o Corrigida)"""

import json
import matplotlib.pyplot as plt
import seaborn as sns
from pathlib import Path
import sys

# Configurar estilo
sns.set_style("whitegrid")
plt.rcParams['figure.figsize'] = (12, 6)
plt.rcParams['font.size'] = 10

# DiretÃ³rios
BASE_DIR = Path("/workspace") if Path("/workspace").exists() else Path("/app")
OUTPUT_DIR = BASE_DIR / "output"
RELATORIO_PATH = OUTPUT_DIR / "relatorio_comparativo.json"

def carregar_relatorio():
    print(f"ðŸ“‚ Carregando relatÃ³rio: {RELATORIO_PATH}")
    if not RELATORIO_PATH.exists():
        print(f"âŒ Erro: RelatÃ³rio nÃ£o encontrado")
        print("   Execute primeiro: ./run.sh full")
        sys.exit(1)
    with open(RELATORIO_PATH, 'r') as f:
        return json.load(f)

def gerar_grafico_tamanho(dados):
    """GrÃ¡fico 1: Tamanho em disco"""
    print("ðŸ“Š Gerando grÃ¡fico de tamanho em disco...")
    
    formatos = list(dados.keys())
    tamanhos_mb = [dados[f]['size_mb'] for f in formatos]
    cores = ['#e74c3c', '#f39c12', '#3498db', '#2ecc71']
    
    fig, ax = plt.subplots(figsize=(10, 6))
    bars = ax.bar(formatos, tamanhos_mb, color=cores, alpha=0.8, edgecolor='black', linewidth=1.5)
    
    # Adicionar valores
    for bar, tamanho in zip(bars, tamanhos_mb):
        height = bar.get_height()
        ax.text(bar.get_x() + bar.get_width()/2., height,
                f'{tamanho:.1f} MB', ha='center', va='bottom', 
                fontsize=12, fontweight='bold')
    
    ax.set_xlabel('Formato de Arquivo', fontsize=13, fontweight='bold')
    ax.set_ylabel('Tamanho em Disco (MB)', fontsize=13, fontweight='bold')
    ax.set_title('ComparaÃ§Ã£o de Tamanho em Disco por Formato\n1 MilhÃ£o de Registros de Sensores IoT', 
                 fontsize=15, fontweight='bold', pad=20)
    ax.grid(axis='y', alpha=0.3, linestyle='--')
    
    plt.tight_layout()
    output_path = OUTPUT_DIR / "grafico_tamanho_disco.png"
    plt.savefig(output_path, dpi=300, bbox_inches='tight', facecolor='white')
    print(f"âœ… Salvo: {output_path}")
    plt.close()

def gerar_grafico_performance(dados):
    """GrÃ¡fico 2: Performance de leitura"""
    print("ðŸ“Š Gerando grÃ¡fico de performance de leitura...")
    
    formatos = list(dados.keys())
    tempo_leitura = [dados[f]['read_time'] for f in formatos]
    tempo_filtro = [dados[f]['filter_time'] for f in formatos]
    tempo_agregacao = [dados[f]['agg_time'] for f in formatos]
    
    x = range(len(formatos))
    width = 0.25
    fig, ax = plt.subplots(figsize=(12, 6))
    
    bars1 = ax.bar([i - width for i in x], tempo_leitura, width, 
                   label='Leitura Completa', color='#3498db', alpha=0.8, edgecolor='black')
    bars2 = ax.bar([i for i in x], tempo_filtro, width, 
                   label='Query com Filtro', color='#2ecc71', alpha=0.8, edgecolor='black')
    bars3 = ax.bar([i + width for i in x], tempo_agregacao, width, 
                   label='Query com AgregaÃ§Ã£o', color='#f39c12', alpha=0.8, edgecolor='black')
    
    # Adicionar valores
    for bars in [bars1, bars2, bars3]:
        for bar in bars:
            height = bar.get_height()
            ax.text(bar.get_x() + bar.get_width()/2., height,
                    f'{height:.2f}s', ha='center', va='bottom', fontsize=9)
    
    ax.set_xlabel('Formato de Arquivo', fontsize=13, fontweight='bold')
    ax.set_ylabel('Tempo de ExecuÃ§Ã£o (segundos)', fontsize=13, fontweight='bold')
    ax.set_title('ComparaÃ§Ã£o de Performance de Leitura e Queries\n1 MilhÃ£o de Registros', 
                 fontsize=15, fontweight='bold', pad=20)
    ax.set_xticks(x)
    ax.set_xticklabels(formatos)
    ax.legend(loc='upper right', fontsize=11, framealpha=0.9)
    ax.grid(axis='y', alpha=0.3, linestyle='--')
    
    plt.tight_layout()
    output_path = OUTPUT_DIR / "grafico_performance.png"
    plt.savefig(output_path, dpi=300, bbox_inches='tight', facecolor='white')
    print(f"âœ… Salvo: {output_path}")
    plt.close()

def gerar_grafico_reducao(dados):
    """GrÃ¡fico 3: ReduÃ§Ã£o percentual vs CSV"""
    print("ðŸ“Š Gerando grÃ¡fico de reduÃ§Ã£o de tamanho...")
    
    formatos = list(dados.keys())
    tamanho_csv = dados['CSV']['size_mb']
    reducoes = [((tamanho_csv - dados[f]['size_mb']) / tamanho_csv * 100) for f in formatos]
    
    # Cores: vermelho para aumento, verde para reduÃ§Ã£o
    cores = ['#e74c3c' if r < 0 else '#2ecc71' for r in reducoes]
    
    fig, ax = plt.subplots(figsize=(10, 6))
    bars = ax.barh(formatos, reducoes, color=cores, alpha=0.8, edgecolor='black', linewidth=1.5)
    
    # Adicionar valores
    for bar, reducao in zip(bars, reducoes):
        width = bar.get_width()
        label_x = width + (2 if width > 0 else -2)
        ax.text(label_x, bar.get_y() + bar.get_height()/2.,
                f'{reducao:+.1f}%', ha='left' if width > 0 else 'right', 
                va='center', fontsize=12, fontweight='bold')
    
    ax.set_xlabel('ReduÃ§Ã£o de Tamanho vs CSV (%)', fontsize=13, fontweight='bold')
    ax.set_ylabel('Formato de Arquivo', fontsize=13, fontweight='bold')
    ax.set_title('ReduÃ§Ã£o de Tamanho em RelaÃ§Ã£o ao CSV\nValores Positivos = Economia de EspaÃ§o', 
                 fontsize=15, fontweight='bold', pad=20)
    ax.axvline(x=0, color='black', linestyle='-', linewidth=1.5)
    ax.grid(axis='x', alpha=0.3, linestyle='--')
    
    plt.tight_layout()
    output_path = OUTPUT_DIR / "grafico_reducao.png"
    plt.savefig(output_path, dpi=300, bbox_inches='tight', facecolor='white')
    print(f"âœ… Salvo: {output_path}")
    plt.close()

def gerar_grafico_speedup(dados):
    """GrÃ¡fico 4: Speedup vs CSV"""
    print("ðŸ“Š Gerando grÃ¡fico de speedup...")
    
    formatos = list(dados.keys())
    tempo_csv = dados['CSV']['read_time']
    speedups = [tempo_csv / dados[f]['read_time'] for f in formatos]
    
    cores = ['#e74c3c', '#f39c12', '#3498db', '#2ecc71']
    
    fig, ax = plt.subplots(figsize=(10, 6))
    bars = ax.bar(formatos, speedups, color=cores, alpha=0.8, edgecolor='black', linewidth=1.5)
    
    # Adicionar valores
    for bar, speedup in zip(bars, speedups):
        height = bar.get_height()
        ax.text(bar.get_x() + bar.get_width()/2., height,
                f'{speedup:.2f}x', ha='center', va='bottom', 
                fontsize=12, fontweight='bold')
    
    ax.axhline(y=1, color='red', linestyle='--', linewidth=2, label='Baseline (CSV = 1x)', alpha=0.7)
    ax.set_xlabel('Formato de Arquivo', fontsize=13, fontweight='bold')
    ax.set_ylabel('Speedup (vezes mais rÃ¡pido que CSV)', fontsize=13, fontweight='bold')
    ax.set_title('Speedup de Leitura em RelaÃ§Ã£o ao CSV\nValores > 1 = Mais RÃ¡pido que CSV', 
                 fontsize=15, fontweight='bold', pad=20)
    ax.legend(loc='upper right', fontsize=11, framealpha=0.9)
    ax.grid(axis='y', alpha=0.3, linestyle='--')
    
    plt.tight_layout()
    output_path = OUTPUT_DIR / "grafico_speedup.png"
    plt.savefig(output_path, dpi=300, bbox_inches='tight', facecolor='white')
    print(f"âœ… Salvo: {output_path}")
    plt.close()

def gerar_tabela_resumo(dados):
    """Gerar tabela resumo em texto"""
    print("ðŸ“Š Gerando tabela resumo...")
    
    output_path = OUTPUT_DIR / "resumo_comparativo.txt"
    
    with open(output_path, 'w', encoding='utf-8') as f:
        f.write("=" * 80 + "\n")
        f.write("RESUMO COMPARATIVO - TEMA B\n")
        f.write("OtimizaÃ§Ã£o de Armazenamento e Consulta\n")
        f.write("=" * 80 + "\n\n")
        
        f.write("TAMANHO EM DISCO:\n")
        f.write("-" * 80 + "\n")
        f.write(f"{'Formato':<12} {'Tamanho (MB)':<15} {'ReduÃ§Ã£o vs CSV':<20}\n")
        f.write("-" * 80 + "\n")
        
        tamanho_csv = dados['CSV']['size_mb']
        for fmt in dados.keys():
            tamanho = dados[fmt]['size_mb']
            reducao = ((tamanho_csv - tamanho) / tamanho_csv * 100)
            f.write(f"{fmt:<12} {tamanho:>10.2f} MB   {reducao:>+8.1f}%\n")
        
        f.write("\n\nPERFORMANCE DE LEITURA:\n")
        f.write("-" * 80 + "\n")
        f.write(f"{'Formato':<12} {'Leitura (s)':<15} {'Filtro (s)':<15} {'AgregaÃ§Ã£o (s)':<15}\n")
        f.write("-" * 80 + "\n")
        
        for fmt in dados.keys():
            f.write(f"{fmt:<12} {dados[fmt]['read_time']:>10.3f}      "
                   f"{dados[fmt]['filter_time']:>10.3f}      "
                   f"{dados[fmt]['agg_time']:>10.3f}\n")
        
        f.write("\n\nSPEEDUP (vs CSV):\n")
        f.write("-" * 80 + "\n")
        f.write(f"{'Formato':<12} {'Speedup':<15}\n")
        f.write("-" * 80 + "\n")
        
        tempo_csv = dados['CSV']['read_time']
        for fmt in dados.keys():
            speedup = tempo_csv / dados[fmt]['read_time']
            f.write(f"{fmt:<12} {speedup:>10.2f}x\n")
        
        f.write("\n" + "=" * 80 + "\n")
    
    print(f"âœ… Salvo: {output_path}")

def main():
    print("=" * 80)
    print("GERAÃ‡ÃƒO DE GRÃFICOS COMPARATIVOS - TEMA B")
    print("=" * 80)
    print()
    
    dados = carregar_relatorio()
    print(f"âœ… RelatÃ³rio carregado com sucesso!")
    print(f"   Formatos analisados: {', '.join(dados.keys())}")
    print()
    
    gerar_grafico_tamanho(dados)
    gerar_grafico_performance(dados)
    gerar_grafico_reducao(dados)
    gerar_grafico_speedup(dados)
    gerar_tabela_resumo(dados)
    
    print()
    print("=" * 80)
    print("âœ… TODOS OS GRÃFICOS E TABELAS GERADOS COM SUCESSO!")
    print("=" * 80)
    print()
    print(f"ðŸ“ LocalizaÃ§Ã£o: {OUTPUT_DIR}")
    print()
    print("Arquivos gerados:")
    print("  1. grafico_tamanho_disco.png")
    print("  2. grafico_performance.png")
    print("  3. grafico_reducao.png")
    print("  4. grafico_speedup.png")
    print("  5. resumo_comparativo.txt")
    print()
    print("ðŸ’¡ Dica: Baixe os arquivos pelo explorador do VS Code")
    print("         (BotÃ£o direito > Download)")
    print()

if __name__ == "__main__":
    main()
SCRIPT_EOF